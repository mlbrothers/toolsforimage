<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Crop your images effortlessly with ToolsForImage. Adjust crop area interactively and preview results in real-time.">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <title>Crop Image - ToolsForImage</title>
    <style>
        .upload-button {
            background-color: var(--link-hover-color);
            color: var(--background-color);
            padding: 20px 40px;
            border: none;
            cursor: pointer;
            font-size: 20px;
            transition: transform 0.3s;
        }

        .upload-button:hover {
            transform: scale(1.1);
        }

        .crop-button {
            background-color: var(--background-color);
            color: var(--box-hover-color);
            border: 2px solid var(--box-hover-color);
            padding: 10px 20px;
            cursor: pointer;
            font-size: 20px;
            transition: transform 0.3s;
            margin-top: 10px;
        }

        .image-preview-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            max-height: 600px;
            margin: 20px auto;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #image-preview {
            max-width: 100%;
            max-height: 100%;
            display: none;
            object-fit: contain;
        }

        #crop-area {
            position: absolute;
            border: 2px dashed #fff;
            box-shadow: 0 0 0 9999em rgba(0, 0, 0, 0.5);
            cursor: move;
        }

        .resize-handle {
            width: 10px;
            height: 10px;
            background-color: white;
            position: absolute;
        }

        .resize-handle.nw { top: -5px; left: -5px; cursor: nw-resize; }
        .resize-handle.ne { top: -5px; right: -5px; cursor: ne-resize; }
        .resize-handle.sw { bottom: -5px; left: -5px; cursor: sw-resize; }
        .resize-handle.se { bottom: -5px; right: -5px; cursor: se-resize; }

        @media (max-width: 600px) {
            .image-preview-container {
                max-width: 100%;
                max-height: 400px;
            }
        }
    </style>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-PR74FHGP0L"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-PR74FHGP0L');
</script>
<body>
    {% include 'nav.html' %}

    <main>
        <h1>Image Crop Tool</h1>
        <p>Easily crop your image by selecting the desired area. Preview your changes in real-time.</p>
        <form id="crop-form" action="/crop-image" method="post" enctype="multipart/form-data">
            <input type="file" id="image-upload" name="image" accept="image/*" style="display: none;" onchange="previewImage(event)">
            <button type="button" class="upload-button" onclick="document.getElementById('image-upload').click();">Upload Image</button>
            <br>
            <div class="image-preview-container">
                <img id="image-preview" src="#" alt="Image Preview">
                <div id="crop-area">
                    <div class="resize-handle nw"></div>
                    <div class="resize-handle ne"></div>
                    <div class="resize-handle sw"></div>
                    <div class="resize-handle se"></div>
                </div>
            </div>
            <input type="hidden" id="crop-x" name="crop-x">
            <input type="hidden" id="crop-y" name="crop-y">
            <input type="hidden" id="crop-width" name="crop-width">
            <input type="hidden" id="crop-height" name="crop-height">
            <button type="submit" class="crop-button" onclick="return validateImageSelection();">Crop Image</button>
        </form>
    </main>

    <script>
        let cropArea, imagePreview, imagePreviewContainer;
        let isDragging = false;
        let isResizing = false;
        let startX, startY, startLeft, startTop, startWidth, startHeight;
        let currentHandle;
        let imageOffset = { x: 0, y: 0 };

        function validateImageSelection() {
            const imageUpload = document.getElementById('image-upload');
            if (!imageUpload.value) {
                alert('Please select an image to upload.');
                return false;
            }
            return true;
        }

        function previewImage(event) {
            imagePreview = document.getElementById('image-preview');
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                    imagePreview.onload = function() {
                        initCropArea();
                    }
                }
                reader.readAsDataURL(file);
            }
        }

        function initCropArea() {
            cropArea = document.getElementById('crop-area');
            imagePreviewContainer = document.querySelector('.image-preview-container');
            const containerRect = imagePreviewContainer.getBoundingClientRect();
            const imageRect = imagePreview.getBoundingClientRect();

            const scale = Math.min(containerRect.width / imageRect.width, containerRect.height / imageRect.height);
            const scaledWidth = imageRect.width * scale;
            const scaledHeight = imageRect.height * scale;

            // Calculate image offset
            imageOffset.x = (containerRect.width - scaledWidth) / 2;
            imageOffset.y = (containerRect.height - scaledHeight) / 2;

            // Adjust initial crop size for small images
            const initialCropSize = Math.min(scaledWidth, scaledHeight, 200);
            
            cropArea.style.width = `${initialCropSize}px`;
            cropArea.style.height = `${initialCropSize}px`;
            cropArea.style.left = `${imageOffset.x + (scaledWidth - initialCropSize) / 2}px`;
            cropArea.style.top = `${imageOffset.y + (scaledHeight - initialCropSize) / 2}px`;

            cropArea.addEventListener('mousedown', startDragging);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDragging);

            const resizeHandles = cropArea.querySelectorAll('.resize-handle');
            resizeHandles.forEach(handle => {
                handle.addEventListener('mousedown', startResizing);
            });

            updateCropValues();
        }

        function startDragging(e) {
            if (e.target.classList.contains('resize-handle')) return;
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            startLeft = cropArea.offsetLeft;
            startTop = cropArea.offsetTop;
            e.preventDefault();
        }

        function drag(e) {
            if (!isDragging) return;
            e.preventDefault();
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            
            let newLeft = startLeft + dx;
            let newTop = startTop + dy;
            
            // Constrain crop area within image bounds
            const imageRect = imagePreview.getBoundingClientRect();
            newLeft = Math.max(imageOffset.x, Math.min(newLeft, imageOffset.x + imageRect.width - cropArea.offsetWidth));
            newTop = Math.max(imageOffset.y, Math.min(newTop, imageOffset.y + imageRect.height - cropArea.offsetHeight));

            cropArea.style.left = newLeft + 'px';
            cropArea.style.top = newTop + 'px';

            updateCropValues();
        }

        function stopDragging() {
            isDragging = false;
        }

        function startResizing(e) {
            isResizing = true;
            currentHandle = e.target;
            startX = e.clientX;
            startY = e.clientY;
            startWidth = parseInt(getComputedStyle(cropArea).width, 10);
            startHeight = parseInt(getComputedStyle(cropArea).height, 10);
            startLeft = cropArea.offsetLeft;
            startTop = cropArea.offsetTop;
            document.addEventListener('mousemove', resize);
            document.addEventListener('mouseup', stopResizing);
            e.stopPropagation();
            e.preventDefault();
        }

        function resize(e) {
            if (!isResizing) return;
            e.preventDefault();
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;

            const imageRect = imagePreview.getBoundingClientRect();
            let newWidth, newHeight, newLeft, newTop;

            if (currentHandle.classList.contains('se')) {
                newWidth = Math.min(startWidth + dx, imageRect.width + imageOffset.x - startLeft);
                newHeight = Math.min(startHeight + dy, imageRect.height + imageOffset.y - startTop);
            } else if (currentHandle.classList.contains('sw')) {
                newWidth = Math.min(startWidth - dx, startLeft + startWidth - imageOffset.x);
                newHeight = Math.min(startHeight + dy, imageRect.height + imageOffset.y - startTop);
                newLeft = Math.max(imageOffset.x, startLeft + dx);
            } else if (currentHandle.classList.contains('ne')) {
                newWidth = Math.min(startWidth + dx, imageRect.width + imageOffset.x - startLeft);
                newHeight = Math.min(startHeight - dy, startTop + startHeight - imageOffset.y);
                newTop = Math.max(imageOffset.y, startTop + dy);
            } else if (currentHandle.classList.contains('nw')) {
                newWidth = Math.min(startWidth - dx, startLeft + startWidth - imageOffset.x);
                newHeight = Math.min(startHeight - dy, startTop + startHeight - imageOffset.y);
                newLeft = Math.max(imageOffset.x, startLeft + dx);
                newTop = Math.max(imageOffset.y, startTop + dy);
            }

            // Ensure minimum size for crop area
            const minSize = 20;
            newWidth = Math.max(newWidth, minSize);
            newHeight = Math.max(newHeight, minSize);

            cropArea.style.width = `${newWidth}px`;
            cropArea.style.height = `${newHeight}px`;
            if (newLeft !== undefined) cropArea.style.left = `${newLeft}px`;
            if (newTop !== undefined) cropArea.style.top = `${newTop}px`;

            updateCropValues();
        }

        function stopResizing() {
            isResizing = false;
            document.removeEventListener('mousemove', resize);
            document.removeEventListener('mouseup', stopResizing);
        }

        function updateCropValues() {
            const containerRect = imagePreviewContainer.getBoundingClientRect();
            const imageRect = imagePreview.getBoundingClientRect();
            
            const scaleX = imagePreview.naturalWidth / imageRect.width;
            const scaleY = imagePreview.naturalHeight / imageRect.height;

            const cropLeft = cropArea.offsetLeft - imageOffset.x;
            const cropTop = cropArea.offsetTop - imageOffset.y;

            document.getElementById('crop-x').value = Math.max(0, Math.round(cropLeft * scaleX));
            document.getElementById('crop-y').value = Math.max(0, Math.round(cropTop * scaleY));
            document.getElementById('crop-width').value = Math.min(
                imagePreview.naturalWidth,
                Math.round(cropArea.offsetWidth * scaleX)
            );
            document.getElementById('crop-height').value = Math.min(
                imagePreview.naturalHeight,
                Math.round(cropArea.offsetHeight * scaleY)
            );
        }
    </script>

    {% include 'footer.html' %}
</body>
</html>
